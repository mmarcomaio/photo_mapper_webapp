<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Photo Map Search</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        /* Navigation */
        nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-link { text-decoration: none; color: #0084ff; font-weight: bold; font-size: 1.1em; }
        .admin-btn { text-decoration: none; background: #e4e6eb; padding: 8px 15px; border-radius: 8px; color: #050505; font-size: 0.9em; font-weight: 600; }
        
        /* Main Card */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* Map Area */
        #map-container { position: relative; width: 100%; height: 450px; background: #222; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        
        /* Tooltip - Sleek black box */
        #custom-tooltip {
            position: fixed;
            display: none;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            pointer-events: none;
            z-index: 10000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* Search UI */
        .search-box { display: flex; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; flex-grow: 1; font-size: 16px; outline: none; }
        input:focus { border-color: #0084ff; }
        button { padding: 12px 24px; background: #0084ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* Results Grid */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .photo-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .photo-card:hover { transform: translateY(-5px); }
        
        .thumb-container { height: 180px; background: #e4e6eb; display: flex; align-items: center; justify-content: center; position: relative; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0084ff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; position: absolute; z-index: 1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; cursor: pointer; position: relative; z-index: 2; }
        .thumb.loaded { opacity: 1; }

        .info { padding: 12px; font-size: 0.9em; }
        .info strong { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #050505; margin-bottom: 4px; }
        .info span { color: #65676b; font-size: 0.85em; }
    </style>
</head>
<body>

<div id="custom-tooltip"></div>

<div class="container">
    <nav>
        <a href="/" class="nav-link">    Home Map</a>
        <a href="/admin" class="admin-btn">    Admin Control</a>
    </nav>
    
    <div class="card">
        <h1 style="margin-top:0;">    Where was that photo?</h1>
        <div id="map-container">
            <div id="map-inner" style="width: 100%; height: 100%;"></div>
        </div>

        <form method="POST" id="searchForm" class="search-box">
            <input type="text" id="queryInput" name="query" value="{{ query }}" placeholder="Search by city, country, or click a blue country..." autocomplete="off">
            <button type="submit">Search</button>
        </form>
    </div>

    <div class="results-grid">
        {% for row in results %}
        <div class="photo-card">
            <a href="/full_image/{{ row['pic_local_path'].lstrip('/') }}" target="_blank">
                <div class="thumb-container">
                    <div class="loader"></div>
                    <img class="thumb" 
                         src="/full_image/{{ row['pic_local_path'].lstrip('/') }}" 
                         loading="lazy" 
                         onload="this.previousElementSibling.style.display='none'; this.classList.add('loaded');">
                </div>
            </a>
            <div class="info">
                <strong>{{ row['pic_local_path'].split('/')[-1] }}</strong>
                <span>    {{ row['city'] or 'Unknown' }}, {{ row['country'] or '' }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if query and not results %}
    <div style="text-align: center; margin-top: 50px; color: #65676b;">
        <p>No photos found for "<strong>{{ query }}</strong>".</p>
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.9/datamaps.world.min.js"></script>

<script>
    window.onload = function() {
        const visitedCountries = {{ visited_countries|tojson }};
        const tooltip = document.getElementById('custom-tooltip');
        
        const isoMapping = {
            "United States": "USA", "France": "FRA", "Italy": "ITA", "Germany": "DEU",
            "Spain": "ESP", "United Kingdom": "GBR", "Canada": "CAN", "Japan": "JPN",
            "India": "IND", "China": "CHN", "Netherlands": "NLD", "Switzerland": "CHE"
        };

        const dataset = {};
        visitedCountries.forEach(name => {
            const code = isoMapping[name];
            if (code) dataset[code] = { fillKey: 'VISITED', countryName: name };
        });

        const map = new Datamap({
            element: document.getElementById('map-inner'),
            projection: 'mercator',
            fills: { defaultFill: '#333', VISITED: '#0084ff' },
            data: dataset,
            geographyConfig: {
                borderColor: '#222',
                highlightOnHover: false, 
                popupOnHover: false      
            },
            done: function(datamap) {
                datamap.svg.selectAll('.datamaps-subunit')
                .on('mouseover', function(geo) {
                    if (dataset[geo.id]) {
                        d3.select(this).style('fill', '#00bfff').style('cursor', 'pointer');
                        tooltip.innerHTML = '<strong>' + geo.properties.name + '</strong>';
                        tooltip.style.display = 'block';
                    } else {
                        d3.select(this).style('fill', '#333').style('cursor', 'default');
                        tooltip.style.display = 'none';
                    }
                })
                .on('mousemove', function() {
                    tooltip.style.left = (d3.event.pageX + 15) + 'px';
                    tooltip.style.top = (d3.event.pageY - 10) + 'px';
                })
                .on('mouseout', function(geo) {
                    d3.select(this).style('fill', dataset[geo.id] ? '#0084ff' : '#333');
                    tooltip.style.display = 'none';
                })
                .on('click', function(geo) {
                    if (dataset[geo.id]) {
                        document.getElementById('queryInput').value = dataset[geo.id].countryName;
                        document.getElementById('searchForm').submit();
                    }
                });
            }
        });
    };
</script>
</body>
</html>