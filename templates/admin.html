<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Photo Map Control</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        h2, h3 { margin-top: 0; color: #1c1e21; }
        
        /* Buttons */
        button { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-blue { background: #0084ff; color: white; width: 100%; font-size: 1.1em; }
        .btn-red { background: #fa3e3e; color: white; }
        .btn-green { background: #42b72a; color: white; text-decoration: none; display: inline-block; }
        .btn-grey { background: #e4e6eb; color: #050505; }
        
        /* Progress Bar */
        .progress-wrapper { margin-top: 20px; }
        .progress-container { width: 100%; background: #e4e6eb; height: 14px; border-radius: 7px; overflow: hidden; margin: 10px 0; }
        #progressBar { width: 0%; height: 100%; background: #0084ff; transition: width 0.3s ease; }
        .scan-info { display: flex; justify-content: space-between; font-size: 0.9em; color: #65676b; margin-bottom: 5px; }

        /* Form elements */
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; }
        .path-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f2f5; }
        code { background: #f0f2f5; padding: 4px 8px; border-radius: 4px; font-family: "SFMono-Regular", Consolas, monospace; }

        /* Scrollable Table */
        .table-wrapper { height: 600px; overflow-y: scroll; border: 1px solid #ddd; border-radius: 8px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; text-align: left; }
        thead { position: sticky; top: 0; background: #f8f9fa; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <p><a href="/" style="text-decoration: none; color: #0084ff;">  Back to Search</a></p>

    <div class="card">
        <h2>    Manual Scan Control</h2>
        
        <div id="scanInitial">
            <button onclick="startScan()" class="btn-blue">Start Full Scan Now</button>
        </div>

        <div id="scanActive" style="display: none;">
            <div class="progress-wrapper">
                <div class="scan-info">
                    <span id="currentFile">Initializing...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="progress-container">
                    <div id="progressBar"></div>
                </div>
            </div>
            <button onclick="stopScan()" class="btn-red" style="width: 100%; margin-top: 10px;">Stop Current Scan</button>
        </div>

        <p style="margin-top: 15px;"><small>Last successful run: <strong id="lastRun">{{ scan_info['last_run'] or 'Never' }}</strong></small></p>
    </div>

    <div class="card">
        <h3>    Managed Folders</h3>
        {% for p in watched_paths %}
        <div class="path-row">
            <code>{{ p['path'] }}</code>
            <form method="POST">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="path_id" value="{{ p['id'] }}">
                <button type="submit" class="btn-red" style="padding: 5px 12px;">Remove</button>
            </form>
        </div>
        {% endfor %}
        <form method="POST" style="margin-top: 20px; display: flex; gap: 10px;">
            <input type="hidden" name="action" value="add">
            <input type="text" name="new_path" placeholder="/volume1/pictures/2024" style="flex-grow: 1;" required>
            <button type="submit" class="btn-green">Add Path</button>
        </form>
    </div>

    <div class="card">
        <h3>    Auto-Scan Frequency</h3>
        <form method="POST">
            <input type="hidden" name="action" value="update_interval">
            Run automated scan every 
            <input type="number" name="interval" value="{{ settings['scan_interval_hours'] }}" min="1" max="168" style="width: 60px;"> 
            hours.
            <button type="submit" class="btn-grey" style="margin-left: 10px;">Update</button>
        </form>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>    Full Database Preview</h3>
            <span id="recordCount" style="font-weight: bold; color: #0084ff; background: #e7f3ff; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;"></span>
        </div>
        <button type="button" id="previewBtn" class="btn-grey" onclick="togglePreview()">Fetch & View Full DB</button>

        <div id="previewContainer" style="display: none;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>Local Path</th><th>GPS</th><th>City</th><th>Country</th></tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" style="border-top: 3px solid #fa3e3e;">
        <h3>    Maintenance</h3>
        <div style="display: flex; gap: 15px;">
            <a href="/admin/db_dump" class="btn-green" style="padding: 10px 20px;">Backup DB</a>
            <form action="/admin/db_reset" method="POST" onsubmit="return confirm('Erase everything?');">
                <button type="submit" class="btn-red">Reset Database</button>
            </form>
        </div>
    </div>
</div>

<script>
    let pollInterval;

    function startScan() {
        fetch('/start_scan', {method: 'POST'})
            .then(() => {
                document.getElementById('scanInitial').style.display = 'none';
                document.getElementById('scanActive').style.display = 'block';
                startPolling();
            });
    }

    function stopScan() {
        if (confirm("Interrupt scan? Current progress will be saved.")) {
            fetch('/stop_scan', {method: 'POST'});
        }
    }

    function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(updateProgress, 1000); // Fast polling during active scan
    }

    function updateProgress() {
        fetch('/scan_progress')
            .then(res => res.json())
            .then(data => {
                const initialDiv = document.getElementById('scanInitial');
                const activeDiv = document.getElementById('scanActive');
                const bar = document.getElementById('progressBar');
                const percentText = document.getElementById('percentText');
                const fileText = document.getElementById('currentFile');
                const lastRunText = document.getElementById('lastRun');

                if (data.active) {
                    initialDiv.style.display = 'none';
                    activeDiv.style.display = 'block';
                    bar.style.width = data.percentage + '%';
                    percentText.innerText = data.percentage + '%';
                    fileText.innerText = "Processing: " + data.current_file;
                } else {
                    initialDiv.style.display = 'block';
                    activeDiv.style.display = 'none';
                    lastRunText.innerText = data.last_run;
                    clearInterval(pollInterval);
                    pollInterval = setInterval(updateProgress, 5000); // Slow polling when idle
                }
            });
    }

    function togglePreview() {
        const container = document.getElementById('previewContainer');
        const btn = document.getElementById('previewBtn');
        const body = document.getElementById('previewBody');
        const counter = document.getElementById('recordCount');

        if (container.style.display === "none") {
            btn.innerText = "Fetching...";
            fetch('/admin/data_preview')
                .then(res => res.text())
                .then(html => {
                    body.innerHTML = html;
                    container.style.display = "block";
                    btn.innerText = "Hide Preview";
                    counter.innerText = body.getElementsByTagName('tr').length + " Photos";
                });
        } else {
            container.style.display = "none";
            btn.innerText = "Fetch & View Full DB";
        }
    }

    // Initialize
    updateProgress();
</script>

</body>
</html>